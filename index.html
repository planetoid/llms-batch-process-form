<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude API Batch Processing</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .loading {
            cursor: not-allowed;
            pointer-events: none;
            opacity: 0.6;
        }
        .submit-btn.loading::after {
            content: '';
            display: inline-block;
            width: 1em;
            height: 1em;
            margin-left: 0.5em;
            border: 0.2em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spinner 0.75s linear infinite;
        }
        @keyframes spinner {
            to { transform: rotate(360deg); }
        }
        .debug-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #f8f9fa;
            border-top: 1px solid #dee2e6;
            padding: 1rem;
            font-size: 0.875rem;
            display: none;
        }
        .debug-panel.show {
            display: block;
        }
        .progress {
            height: 0.5rem;
        }
        .form-content.disabled {
            opacity: 0.5;
            pointer-events: none;
        }
    </style>
</head>
<body>
<div class="container mt-5 mb-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="card-title mb-0">Claude API Batch Processing</h3>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="toggleDebug">Debug</button>
                </div>
                <div class="card-body">
                    <div class="alert alert-info mb-4">
                        <h5 class="alert-heading">API Endpoint Status</h5>
                        <p class="mb-0" id="currentEndpoint">Please enter your Cloudflare Worker endpoint to begin</p>
                        <div id="endpointStatus"></div>
                    </div>

                    <form id="batchForm">
                        <div class="mb-3">
                            <label for="apiEndpoint" class="form-label">Worker Endpoint</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="apiEndpoint"
                                       placeholder="https://your-worker.workers.dev" required>
                                <button class="btn btn-outline-secondary" type="button" id="testEndpoint" disabled>Test</button>
                            </div>
                            <div class="form-text">Your Cloudflare Worker endpoint URL</div>
                        </div>

                        <div class="form-content disabled">
                            <div class="mb-3">
                                <label for="apiKey" class="form-label">API Key</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="apiKey" required>
                                    <button class="btn btn-outline-secondary" type="button" id="toggleApiKey">
                                        <span class="d-none">Hide</span>
                                        <span>Show</span>
                                    </button>
                                </div>
                                <div class="form-text">Your Anthropic API key for authentication</div>
                            </div>

                            <div class="mb-3">
                                <label for="model" class="form-label">Model</label>
                                <select class="form-select" id="model" required>
                                    <option value="claude-3-5-sonnet-20241022">Claude 3.5 Sonnet (Latest)</option>
                                    <option value="claude-3-5-sonnet-20240620">Claude 3.5 Sonnet</option>
                                    <option value="claude-3-5-haiku-20241022">Claude 3.5 Haiku</option>
                                    <option value="claude-3-haiku-20240307">Claude 3 Haiku</option>
                                    <option value="claude-3-opus-20240229">Claude 3 Opus</option>
                                </select>
                                <div class="form-text">Select the Claude model version</div>
                            </div>

                            <div class="mb-3">
                                <label for="maxTokens" class="form-label">Max Tokens</label>
                                <input type="number" class="form-control" id="maxTokens" value="1024" min="1" max="4096" required>
                                <div class="form-text">Maximum number of tokens (1-4096) to generate in the response</div>
                            </div>

                            <div class="mb-3">
                                <label for="systemPrompt" class="form-label">System Prompt</label>
                                <textarea class="form-control" id="systemPrompt" rows="3"></textarea>
                                <div class="form-text">Optional system message to set context or behavior for the model</div>
                            </div>

                            <div class="mb-3 form-check">
                                <input type="checkbox" class="form-check-input" id="useCache" checked>
                                <label class="form-check-label" for="useCache">Enable Cache</label>
                                <div class="form-text">
                                    Enable prompt caching to reduce costs (30-98% cache hit rates). Cache entries expire after 5 minutes.
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="excelFile" class="form-label">Upload Excel File</label>
                                <input type="file" class="form-control" id="excelFile" accept=".xlsx,.xls" required>
                                <div class="form-text">
                                    Upload Excel file with columns: custom_id (unique identifier) and user_message (content to send).
                                    Maximum 100,000 requests or 256 MB per batch.
                                </div>
                            </div>

                            <div id="excelInfo" class="alert alert-info d-none">
                                <div class="excel-summary"></div>
                                <div class="excel-preview mt-2 d-none">
                                    <h6>Data Preview:</h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                            <tr>
                                                <th>custom_id</th>
                                                <th>user_message</th>
                                            </tr>
                                            </thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary w-100 submit-btn" disabled>Submit Batch</button>
                    </form>

                    <div id="error" class="alert alert-danger mt-3 d-none"></div>
                    <div id="status" class="alert alert-success mt-3 d-none">
                        <div id="statusContent"></div>
                        <div class="progress mt-3 d-none">
                            <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Debug Panel -->
<div class="debug-panel">
    <div class="container">
        <div class="row">
            <div class="col">
                <h6>Debug Information</h6>
                <pre id="debugOutput" class="bg-light p-2" style="max-height: 200px; overflow-y: auto;"></pre>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
    // State management
    const debugState = {
        domLoaded: false,
        xlsxLoaded: false,
        initCompleted: false,
        errors: [],
        logs: []
    };

    let isProcessing = false;
    let excelData = [];
    const pageLoadStart = performance.now();

    // Debug functionality
    function debugLog(message, type = 'info') {
        const timestamp = new Date().toISOString();
        const log = `[${timestamp}] [${type}] ${message}`;
        debugState.logs.push(log);

        const debugOutput = document.getElementById('debugOutput');
        if (debugOutput) {
            debugOutput.textContent = debugState.logs.join('\n');
            debugOutput.scrollTop = debugOutput.scrollHeight;
        }

        console[type](message);
    }

    // Toggle debug panel
    document.getElementById('toggleDebug').addEventListener('click', () => {
        document.querySelector('.debug-panel').classList.toggle('show');
    });

    // Toggle API key visibility
    document.getElementById('toggleApiKey').addEventListener('click', (e) => {
        const input = document.getElementById('apiKey');
        const spans = e.currentTarget.getElementsByTagName('span');
        if (input.type === 'password') {
            input.type = 'text';
            spans[0].classList.remove('d-none');
            spans[1].classList.add('d-none');
        } else {
            input.type = 'password';
            spans[0].classList.add('d-none');
            spans[1].classList.remove('d-none');
        }
    });

    // Form initialization
    function initializeForm() {
        const endpoint = document.getElementById('apiEndpoint');
        const testButton = document.getElementById('testEndpoint');
        const formContent = document.querySelector('.form-content');
        const submitButton = document.querySelector('button[type="submit"]');

        // Update form state based on endpoint
        function updateFormState() {
            const hasEndpoint = endpoint.value.trim() !== '';
            testButton.disabled = !hasEndpoint;
            formContent.classList.toggle('disabled', !hasEndpoint);
            submitButton.disabled = !hasEndpoint;

            if (!hasEndpoint) {
                document.getElementById('currentEndpoint').textContent =
                    'Please enter your Cloudflare Worker endpoint to begin';
            } else {
                document.getElementById('currentEndpoint').textContent =
                    `Current endpoint: ${endpoint.value.trim()}`;
            }
        }

        // Test endpoint connection
        async function testEndpoint() {
            const url = endpoint.value.trim();
            if (!url) return;

            testButton.disabled = true;
            testButton.textContent = 'Testing...';

            try {
                const response = await fetch(url, {
                    method: 'OPTIONS'
                });

                if (response.ok) {
                    updateEndpointStatus('Endpoint connection successful', 'success');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                updateEndpointStatus(`Connection failed: ${error.message}`, 'danger');
            } finally {
                testButton.disabled = false;
                testButton.textContent = 'Test';
            }
        }

        endpoint.addEventListener('input', updateFormState);
        testButton.addEventListener('click', testEndpoint);
        updateFormState();
    }

    // Update endpoint status
    function updateEndpointStatus(message, type = 'info') {
        const statusDiv = document.getElementById('endpointStatus');
        statusDiv.innerHTML = `<div class="alert alert-${type} mb-0 mt-2">${message}</div>`;
    }

    // Excel file handling
    document.getElementById('excelFile').addEventListener('change', handleFileUpload);

    function handleFileUpload(e) {
        const file = e.target.files[0];
        if (!file) return;

        debugLog(`Processing file: ${file.name}`);
        const reader = new FileReader();

        reader.onload = (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                excelData = XLSX.utils.sheet_to_json(worksheet);

                debugLog(`Excel data loaded: ${excelData.length} rows`);
                showExcelInfo();

            } catch (error) {
                debugLog(`Excel processing error: ${error.message}`, 'error');
                showError('Error reading Excel file: ' + error.message);
            }
        };

        reader.onerror = () => {
            const error = 'Error reading file';
            debugLog(error, 'error');
            showError(error);
        };

        reader.readAsArrayBuffer(file);
    }

    function showExcelInfo() {
        const infoElement = document.getElementById('excelInfo');
        const summaryElement = infoElement.querySelector('.excel-summary');
        const previewElement = infoElement.querySelector('.excel-preview');
        const previewBody = previewElement.querySelector('tbody');

        summaryElement.textContent = `Loaded ${excelData.length} rows from Excel`;

        if (excelData.length > 0) {
            previewBody.innerHTML = '';
            excelData.slice(0, 5).forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                        <td>${row.custom_id || 'N/A'}</td>
                        <td>${row.user_message ? row.user_message.substring(0, 50) + '...' : 'N/A'}</td>
                    `;
                previewBody.appendChild(tr);
            });
            previewElement.classList.remove('d-none');
        }

        infoElement.classList.remove('d-none');
    }

    // Form submission handling
    document.getElementById('batchForm').addEventListener('submit', handleFormSubmit);

    async function handleFormSubmit(e) {
        e.preventDefault();
        if (isProcessing) return;

        const form = e.target;
        const submitBtn = form.querySelector('button[type="submit"]');

        resetStatus();

        if (!excelData.length) {
            showError('Please upload an Excel file first');
            return;
        }

        const formData = getFormData();
        if (!validateFormData(formData)) return;

        try {
            debugLog('Starting batch submission...');
            setProcessing(true, submitBtn);
            const requests = createRequests(formData);
            debugLog(`Created ${requests.length} requests`);

            const response = await sendBatchRequest(formData, requests);
            const data = await handleResponse(response);
            debugLog('Batch submitted successfully', 'info');
            showStatus(data);
        } catch (error) {
            debugLog(`Batch submission error: ${error.message}`, 'error');
            handleError(error);
        } finally {
            setProcessing(false, submitBtn);
        }
    }

    // Form data handling
    function getFormData() {
        return {
            apiEndpoint: document.getElementById('apiEndpoint').value.trim(),
            apiKey: document.getElementById('apiKey').value,
            model: document.getElementById('model').value,
            maxTokens: parseInt(document.getElementById('maxTokens').value),
            systemPrompt: document.getElementById('systemPrompt').value.trim(),
            useCache: document.getElementById('useCache').checked
        };
    }

    function validateFormData(formData) {
        if (!formData.apiEndpoint) {
            showError('Please enter the Worker endpoint');
            return false;
        }
        if (!formData.apiKey) {
            showError('Please enter your API key');
            return false;
        }
        if (!formData.model) {
            showError('Please select a model');
            return false;
        }
        if (isNaN(formData.maxTokens) || formData.maxTokens < 1 || formData.maxTokens > 4096) {
            showError('Max tokens must be between 1 and 4096');
            return false;
        }
        return true;
    }

    // Request creation and handling
    function createRequests(formData) {
        return excelData.map(row => ({
            custom_id: row.custom_id?.toString() || generateCustomId(),
            params: {
                model: formData.model,
                max_tokens: formData.maxTokens,
                system: formData.systemPrompt ? [
                    {
                        type: "text",
                        text: formData.systemPrompt,
                        cache_control: { type: "ephemeral" }
                    }
                ] : undefined,
                messages: [{
                    role: 'user',
                    content: row.user_message
                }]
            }
        }));
    }

    function generateCustomId() {
        return 'req_' + Math.random().toString(36).substr(2, 9);
    }

    async function sendBatchRequest(formData, requests) {
        const endpoint = `${formData.apiEndpoint}/messages/batches`;
        debugLog(`Sending request to: ${endpoint}`);

        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'x-api-key': formData.apiKey,
                'anthropic-version': '2023-06-01',
                'content-type': 'application/json'
            },
            body: JSON.stringify({
                requests,
                use_cache: formData.useCache
            })
        });

        if (!response.ok) {
            const data = await response.json();
            throw new Error(data.error?.message || `HTTP ${response.status}`);
        }

        return response;
    }

    async function handleResponse(response) {
        const data = await response.json();
        if (!response.ok) {
            throw new Error(data.error?.message || `HTTP ${response.status}`);
        }
        return data;
    }

    // UI state management
    function setProcessing(processing, submitBtn) {
        isProcessing = processing;
        submitBtn.disabled = processing;
        submitBtn.classList.toggle('loading', processing);
    }

    function showError(message) {
        const errorDiv = document.getElementById('error');
        errorDiv.textContent = message;
        errorDiv.classList.remove('d-none');
    }

    function handleError(error) {
        showError(error.message);
        const submitBtn = document.querySelector('button[type="submit"]');
        setProcessing(false, submitBtn);  // 確保傳入正確的按鈕元素
    }

    function showStatus(data) {
        const statusDiv = document.getElementById('status');
        const statusContent = document.getElementById('statusContent');
        const progressBar = statusDiv.querySelector('.progress-bar');

        statusContent.innerHTML = `
                <h5>Batch Submitted Successfully</h5>
                <p>Batch ID: ${data.batch_id}</p>
                <p>Status: ${data.status}</p>
                <p>Total Requests: ${data.total_requests}</p>
            `;

        if (data.progress) {
            progressBar.style.width = `${data.progress * 100}%`;
            progressBar.parentElement.classList.remove('d-none');
        }

        statusDiv.classList.remove('d-none');
    }

    function resetStatus() {
        document.getElementById('error').classList.add('d-none');
        document.getElementById('status').classList.add('d-none');
        document.querySelector('.progress').classList.add('d-none');
        document.querySelector('.progress-bar').style.width = '0%';
    }

    // Initialize everything when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
        initializeForm();
        debugState.domLoaded = true;
        debugLog('DOM loaded, form initialized');

        // Check XLSX library
        if (typeof XLSX !== 'undefined') {
            debugState.xlsxLoaded = true;
            debugLog('XLSX library loaded successfully');
        } else {
            const error = 'XLSX library failed to load';
            debugState.errors.push(error);
            debugLog(error, 'error');
        }

        debugState.initCompleted = true;
        const loadTime = performance.now() - pageLoadStart;
        debugLog(`Initialization completed in ${loadTime}ms`);
    });
</script>